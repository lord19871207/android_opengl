#version 300 es

uniform sampler2D sTexture;
uniform vec2 uSampleOffset;
uniform int uSampleCount;

in vec2 vTexPosition;

out vec4 outFragColor;

void sample(inout vec4 sampleSum, inout float weightSum, in vec2 texPos) {
    vec4 sample = texture(sTexture, texPos);
    float weight = sample.a;
    sampleSum += sample * weight;
    weightSum += weight;
}

void main() {
    vec4 sampleCenter = texture(sTexture, vTexPosition);
    float coc = sampleCenter.a;
    //outFragColor = sampleCenter;
    //return;

    vec4 sampleSum = sampleCenter;
    float weightSum = 1.0;

    vec2 texOffset = uSampleOffset * coc * 0.5;

    for (int i = 0; i < uSampleCount; ++i) {
        sample(sampleSum, weightSum, vTexPosition + texOffset);
        sample(sampleSum, weightSum, vTexPosition - texOffset);
        texOffset += uSampleOffset * coc;
    }

    outFragColor = sampleSum / weightSum;
}
